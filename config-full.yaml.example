# LLMProxy 完整配置示例
# 包含所有新功能：智能路由、鉴权、限流
# 完整配置参考: docs/config-reference.yaml

server:
  listen: ":8000"
  read_timeout: 30s
  idle_timeout: 120s

log:
  level: info
  format: json
  output: stdout

# 后端服务器列表
backends:
  - name: vllm-1
    url: "http://vllm-server-1:8000"
    weight: 10
  - name: vllm-2
    url: "http://vllm-server-2:8000"
    weight: 10
  - name: ollama-1
    url: "http://ollama-server-1:11434"
    weight: 10
  - name: ollama-2
    url: "http://ollama-server-2:11434"
    weight: 10

# Admin API 配置
admin:
  enabled: true
  token: "your-secure-admin-token"
  db_path: "./data/keys.db"

# 鉴权配置
auth:
  enabled: true
  mode: first_match
  header_names:
    - Authorization
    - X-API-Key
  skip_paths:
    - /health
    - /metrics
  pipeline:
    # 使用内置 SQLite 存储（依赖 admin 模块）
    - name: builtin_auth
      type: builtin
      enabled: true
    # 或者使用静态配置
    # - name: static_keys
    #   type: static
    #   enabled: true
    #   static:
    #     keys:
    #       - key: "sk-llmproxy-dev-team-001"
    #         name: "研发部门"
    #         user_id: "dept_dev"
    #         status: "active"
    #         total_quota: 500000
    #       - key: "sk-llmproxy-test-001"
    #         name: "测试环境"
    #         user_id: "test"
    #         status: "active"
    #         total_quota: 100000

# 智能路由配置
routing:
  enabled: true
  load_balance: least_connections  # round_robin / least_connections / latency_based
  timeout: 60s
  retry:
    enabled: true
    max_retries: 3
    initial_wait: 1s
    max_wait: 10s
    multiplier: 2.0

# 限流配置
rate_limit:
  enabled: true
  storage: memory  # memory / redis
  redis: default   # 引用 storage.caches 中的连接（仅当 storage: redis 时生效）
  global:
    enabled: true
    requests_per_second: 1000
    burst_size: 2000
  per_key:
    enabled: true
    requests_per_second: 10
    requests_per_minute: 500
    tokens_per_minute: 100000
    max_concurrent: 5
    burst_size: 20

# 用量上报配置
usage:
  enabled: true
  reporters:
    # 内置 SQLite 存储
    - name: local
      type: builtin
      enabled: true
      builtin:
        retention_days: 30
    # Webhook 上报（可选）
    - name: billing
      type: webhook
      enabled: true
      webhook:
        url: "http://billing-api:8080/api/v1/usage"
        timeout: 2s
        retry: 3

# 健康检查配置
health_check:
  enabled: true
  interval: 10s
  path: /health

# 指标配置
metrics:
  enabled: true
  path: /metrics
