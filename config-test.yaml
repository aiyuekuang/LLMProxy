# 测试配置文件
listen: ":8000"

# 后端服务器（使用本地 Ollama）
backends:
  - url: "http://host.docker.internal:11434"
    weight: 10

# 智能路由配置
routing:
  # 自动重试
  retry:
    enabled: true
    max_retries: 2
    initial_wait: 500ms
    max_wait: 5s
    multiplier: 2.0
  
  # 负载均衡策略
  load_balance_strategy: "round_robin"

# 鉴权配置
auth:
  enabled: true
  mode: "first_match"
  pipeline:
    - name: "redis-admin"
      type: "redis"
      enabled: true
      redis:
        addr: "llmproxy-admin-redis:6379"
        password: ""
        db: 0
        key_pattern: "llmproxy:key:{api_key}"
      lua_script: |
        -- 状态检查 (Admin 用 enabled, 这里转换)
        if data.status ~= "enabled" and data.status ~= "active" then
          return {allow = false, message = "API Key 已禁用"}
        end
        -- 额度检查 (-1 表示无限)
        local quota = tonumber(data.quota) or -1
        local used = tonumber(data.used) or 0
        if quota > 0 and used >= quota then
          return {allow = false, message = "额度已用尽"}
        end
        return {allow = true, metadata = {user_id = data.user_id}}

# 限流配置
rate_limit:
  enabled: true
  storage: "memory"
  
  # 全局限流
  global:
    enabled: true
    requests_per_second: 100
    burst_size: 200
  
  # Key 级限流
  per_key:
    enabled: true
    requests_per_second: 10
    burst_size: 20
    max_concurrent: 5

# 健康检查
health_check:
  interval: 10s
  path: /
